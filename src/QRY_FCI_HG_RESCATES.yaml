name: FCISTDR/QRY_FCI_HG_RESCATES
caption: FCI STDR - Solicitud de Rescates
view: |
  with 
  rescates as (
      select 
          t."IRM_TAREA_ID" as "idOrigen",
          unf."CODIGO" as codigo_fci,
          '[' ||unf."CODIGO" ||'] ' || unf."NOMBRE" as fci,
          p."ID" as cuit,
          "ASUNTO",
          c."ID",
          '[' || c."ID" ||'] ' || c."DENOMINACION" as cuenta, 
          cfci."ID" as cuenta_fci,
          uni."CODIGO" as unidad,
          t."DINERO",
          (case when t."DINERO" then 'Monto' else 'Cuotapartes' end) as tipo_rescate,
          unf."PLAZOLIQUDACIONRESCATE" as plazo_liq,
          cm."CODIGO" as mkt,
          chro."CODIGO" as "T+0",
          chr."CODIGO" as "T++",
          t."ESTADO", 
          "FECHA"::date, 
          "FECHAFIN"::date, 
          "PROPIETARIO",
          t."TIPO", "SOLICITUD", t."CLASS", "CONTEXTO", 
          t."CANTIDAD" as cantidad,
          t."VALORCUOTAPARTE", 
          t."CANTIDADCUOTAPARTES",
          "CANTIDADSOLICITUD", "UNIDAD", "FECHASOLICITUD",
          "INTEGRACOMITENTE", 
          unf."ACPIC", p."DENOMINACION"
      from "IRM_TAREA" t
          inner join "CTA_ESQUEMA" c on c."CTA_ESQUEMA_ID"  = t."CUENTA"
          inner join "SEC_USUARIO" u on u."SEC_USUARIO_ID" = t."PROPIETARIO"
          inner join "UNI_UNIDAD" unf on unf."UNI_UNIDAD_ID"=t."FCI" 
          inner join "GNT_PERSONA" p on p."GNT_PERSONA_ID" = unf."ACPIC"
          left join "CTA_CODIGO_INTEGRACION" cm on unf."CUENTAAAPIC"=cm."ESQUEMA" and cm."CODIFICACION"='Modo operativo FCI'
          left join "CTA_CODIGO_INTEGRACION" chro on unf."CUENTAAAPIC"=chro."ESQUEMA" and chro."CODIFICACION"='Límite presentación rescate FCI T+0'
          left join "CTA_CODIGO_INTEGRACION" chr on unf."CUENTAAAPIC"=chr."ESQUEMA" and chr."CODIFICACION"='Límite presentación rescate FCI T++'
          left join "CTA_CODIGO_INTEGRACION" chs on unf."CUENTAAAPIC"=chs."ESQUEMA" and chs."CODIFICACION"='Límite presentación suscripción FCI'
          left join "CTA_ESQUEMA" cfci on cfci."CTA_ESQUEMA_ID" = unf."CUENTAAAPIC"
          left join "UNI_UNIDAD" uni on uni."UNI_UNIDAD_ID"=unf."MONEDA"
      where t."CLASS" = 'com.aunesa.irmo.model.acdi.ISolicitudRescateFCI'
          and t."ESTADO" = 'Liquidación pendiente'),
  primera_agrupacion as(
      select 
          codigo_fci,
          "VALORCUOTAPARTE",
          sum("CANTIDADSOLICITUD")::double precision as "CP_X_CUENTA",
          tipo_rescate,
          "FECHA", "FECHAFIN",
          cuit,
          "ID" as cuenta,
          json_agg(json_build_object('cantidad',"CANTIDADSOLICITUD"::double precision, 'idOrden', "idOrigen"::bigint, 'solicitud', "SOLICITUD", 'propietario',"PROPIETARIO") order by "idOrigen") as origenes,
          cuenta_fci,unidad,"DINERO", plazo_liq,
          mkt,
          "T+0",
          "T++",
          fci, 
          "ESTADO", 
          "TIPO", "CLASS", "CONTEXTO", 
          "UNIDAD", "FECHASOLICITUD",
          "INTEGRACOMITENTE", "ACPIC", "DENOMINACION"
      from rescates
      where (plazo_liq = 0) = (?= 'T+0')
          group by "ID", codigo_fci, "VALORCUOTAPARTE",cuit,
          cuenta_fci,
          unidad,
          "DINERO", tipo_rescate,plazo_liq,
          mkt,
          "T+0",
          "T++",
          codigo_fci,
          fci, 
          "ESTADO", 
          "FECHA", "FECHAFIN",
          "TIPO", "CLASS", "CONTEXTO", 
          "UNIDAD", "FECHASOLICITUD",
          "INTEGRACOMITENTE", "ACPIC", "DENOMINACION")

      select 
          codigo_fci,
          "VALORCUOTAPARTE",
          sum("CP_X_CUENTA") as cp_total,
          tipo_rescate,
          "FECHA", "FECHAFIN",
          cuit,
          json_agg(json_build_object('cantidad', "CP_X_CUENTA", 'cuenta', cuenta, 'origenes', origenes))::text as resumen_orden,
          cuenta_fci,unidad,"DINERO", plazo_liq,
          mkt,
          "T+0",
          "T++",
          fci, 
          "ESTADO", 
          "TIPO", "CLASS", "CONTEXTO", 
          "UNIDAD", "FECHASOLICITUD",
          "INTEGRACOMITENTE", "ACPIC", "DENOMINACION"
      from primera_agrupacion
      where "FECHA" = current_date
          group by 
          codigo_fci, "VALORCUOTAPARTE",cuit, 
          cuenta_fci,
          unidad,
          "DINERO", tipo_rescate,plazo_liq,
          mkt,
          "T+0",
          "T++",
          codigo_fci,
          fci, 
          "ESTADO", 
          "FECHA", "FECHAFIN",
          "TIPO", "CLASS", "CONTEXTO", 
          "UNIDAD", "FECHASOLICITUD",
          "INTEGRACOMITENTE", "ACPIC", "DENOMINACION"

viewBindings:
  - plazo_liq
#postProcessors:
#- FCISTDR/TEMPLATE_QRY_FCI_HG_RESCATES
columns:
- name: resumen_orden
  caption: Resumen de orden
  fieldType: java.lang.String
  width: 8
- name: plazo_liq
  caption: Plazo de liquidación
  fieldType: java.lang.Integer
- name: cuit
  caption: CUIT
  fieldType: java.lang.String
- name: cp_total
  caption: Cuotapartes
  fieldType: java.lang.Double
- name: codigo_fci
  caption: Código FCI
  fieldType: java.lang.String
#- name: template
#  caption: Template
#  fieldType: java.lang.String
#template: |
#  <div inner-h-t-m-l="[[item.template]]"></div>
sortables: []
targetUsers: []
targetGroups:
- ADMIN
- OPB
filterGroup:
  caption: Filtros
  filters:
  - name: plazo_liq
    caption: Plazo de liquidación
    fieldType: java.lang.Boolean
    required: true
    dependents: []
    possibleValues:
      - "T+0"
      - "T++"
  subgroups: []
dataSource: SYC
dataSourceOptions: {}
reports: []
services: []
scripts:
- FCISTDR/RESCATE_ALTA_INGRESO
selectionScript: |
  #!python3
  import redflagbpm
  bpm = redflagbpm.BPMService()
  bpm.reply("Cantidad seleccionada: " + str(len(bpm.context["selection"])))
context: {}
exportable: true